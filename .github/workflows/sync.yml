name: "ðŸ³ Sync DockerHub â†’ Aliyun"

on:
  workflow_dispatch:
    inputs:
      image:
        description: |
          æºé•œåƒåœ°å€ï¼ˆæ”¯æŒå¤šè¡Œæ‰¹é‡è¾“å…¥ï¼Œæ¯è¡Œä¸€ä¸ªï¼‰
          ç¤ºä¾‹: vllm/vllm-openai:nightly
        required: true
        type: string
      method:
        description: "åŒæ­¥æ–¹å¼ï¼šcraneï¼ˆå¿«é€Ÿè½»é‡ï¼‰æˆ– dockerï¼ˆç¨³å®šå¯é ï¼Œé€‚åˆå¤§é•œåƒï¼‰"
        required: true
        type: choice
        default: docker
        options:
          - docker
          - crane

# â”€â”€â”€ å›ºåŒ–é…ç½® â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
env:
  REGISTRY: registry.cn-hangzhou.aliyuncs.com
  NAMESPACE: dslab

jobs:
  sync:
    name: "ðŸ“¦ Sync Images (${{ inputs.method }})"
    runs-on: ubuntu-latest
    steps:
      # â”€â”€ 1. å®‰è£… craneï¼ˆä»… crane æ¨¡å¼ï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ”§ Install crane
        if: inputs.method == 'crane'
        run: |
          VERSION=$(curl -s "https://api.github.com/repos/google/go-containerregistry/releases/latest" | jq -r '.tag_name')
          curl -sL "https://github.com/google/go-containerregistry/releases/download/${VERSION}/go-containerregistry_Linux_x86_64.tar.gz" | tar xzf - crane
          sudo mv crane /usr/local/bin/
          crane version

      # â”€â”€ 2. ç™»å½• DockerHubï¼ˆå¯é€‰ï¼Œé¿å…åŒ¿åé™é€Ÿï¼‰â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ”‘ Login to DockerHub (optional)
        env:
          DOCKERHUB_USERNAME: ${{ secrets.DOCKERHUB_USERNAME }}
          DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
        run: |
          if [[ -n "$DOCKERHUB_USERNAME" && -n "$DOCKERHUB_TOKEN" ]]; then
            if [[ "${{ inputs.method }}" == "crane" ]]; then
              crane auth login index.docker.io -u "$DOCKERHUB_USERNAME" -p "$DOCKERHUB_TOKEN"
            else
              echo "$DOCKERHUB_TOKEN" | docker login -u "$DOCKERHUB_USERNAME" --password-stdin
            fi
            echo "âœ… DockerHub å·²ç™»å½•"
          else
            echo "â­ï¸ è·³è¿‡ DockerHub ç™»å½•ï¼ˆæœªé…ç½®å‡­æ®ï¼Œå°†ä½¿ç”¨åŒ¿åæ‹‰å–ï¼‰"
          fi

      # â”€â”€ 3. ç™»å½•é˜¿é‡Œäº‘å®¹å™¨é•œåƒæœåŠ¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸ”‘ Login to Aliyun Registry
        run: |
          if [[ "${{ inputs.method }}" == "crane" ]]; then
            crane auth login "$REGISTRY" -u "${{ secrets.ALIYUN_USERNAME }}" -p "${{ secrets.ALIYUN_PASSWORD }}"
          else
            echo "${{ secrets.ALIYUN_PASSWORD }}" | docker login "$REGISTRY" -u "${{ secrets.ALIYUN_USERNAME }}" --password-stdin
          fi
          echo "âœ… é˜¿é‡Œäº‘ Registry å·²ç™»å½•"

      # â”€â”€ 4. ç£ç›˜ç©ºé—´æ¸…ç†ï¼ˆdocker æ¨¡å¼ï¼Œå¤§é•œåƒéœ€è¦ç©ºé—´ï¼‰â”€â”€â”€â”€â”€
      - name: ðŸ§¹ Free disk space (docker mode)
        if: inputs.method == 'docker'
        run: |
          echo "æ¸…ç†å‰ç£ç›˜ç©ºé—´:"
          df -h /
          sudo rm -rf /usr/local/lib/android /usr/share/dotnet /opt/ghc /usr/local/share/boost
          sudo docker system prune -af
          echo "æ¸…ç†åŽç£ç›˜ç©ºé—´:"
          df -h /

      # â”€â”€ 5. åŒæ­¥é•œåƒ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      - name: ðŸš€ Sync images
        id: sync
        run: |
          set +e  # å…è®¸å•ä¸ªå¤±è´¥ä¸ä¸­æ–­æ•´ä½“
          METHOD="${{ inputs.method }}"

          # â”€â”€ åˆå§‹åŒ– Summary è¡¨å¤´ â”€â”€
          echo "## ðŸ³ é•œåƒåŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ“‹ åŒæ­¥æ–¹å¼: **${METHOD}**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| çŠ¶æ€ | æºé•œåƒ | é˜¿é‡Œäº‘é•œåƒ | æ‹‰å–å‘½ä»¤ |" >> $GITHUB_STEP_SUMMARY
          echo "|:----:|--------|-----------|----------|" >> $GITHUB_STEP_SUMMARY

          SUCCESS=0
          FAIL=0
          TOTAL=0

          # â”€â”€ é€è¡Œå¤„ç†è¾“å…¥ â”€â”€
          while IFS= read -r line; do
            # è·³è¿‡ç©ºè¡Œå’Œæ³¨é‡Šè¡Œ
            line=$(echo "$line" | xargs)
            [[ -z "$line" || "$line" == \#* ]] && continue

            TOTAL=$((TOTAL + 1))
            SRC="$line"

            # â”€â”€ è§£æžé•œåƒåå’Œ tag â”€â”€
            if [[ "$SRC" == *:* ]]; then
              IMAGE_WITH_TAG="$SRC"
            else
              IMAGE_WITH_TAG="${SRC}:latest"
            fi

            IMAGE_PART="${IMAGE_WITH_TAG%%:*}"
            TAG="${IMAGE_WITH_TAG##*:}"

            # æå–é•œåƒçŸ­åï¼ˆå–æœ€åŽä¸€æ®µ / åŽé¢çš„éƒ¨åˆ†ï¼‰
            if [[ "$IMAGE_PART" == */* ]]; then
              SHORT_NAME="${IMAGE_PART##*/}"
            else
              SHORT_NAME="$IMAGE_PART"
            fi

            DST="${REGISTRY}/${NAMESPACE}/${SHORT_NAME}:${TAG}"

            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"
            echo "ðŸ“¦ [$TOTAL] $SRC â†’ $DST (method: $METHOD)"
            echo "â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€"

            # â”€â”€ æ‰§è¡ŒåŒæ­¥ â”€â”€
            SYNC_OK=false
            if [[ "$METHOD" == "crane" ]]; then
              # â”€ crane æ¨¡å¼ï¼šç›´æŽ¥ registry-to-registry å¤åˆ¶ â”€
              if crane copy "$SRC" "$DST" --platform all 2>&1; then
                SYNC_OK=true
              fi
            else
              # â”€ docker æ¨¡å¼ï¼špull â†’ tag â†’ push â”€
              if docker pull "$SRC" 2>&1; then
                docker tag "$SRC" "$DST"
                if docker push "$DST" 2>&1; then
                  SYNC_OK=true
                fi
                # æ¸…ç†æœ¬åœ°é•œåƒé‡Šæ”¾ç©ºé—´
                docker rmi "$SRC" "$DST" 2>/dev/null || true
              fi
            fi

            if [[ "$SYNC_OK" == "true" ]]; then
              echo "âœ… æˆåŠŸ: $SRC"
              echo "| âœ… | \`$SRC\` | \`${NAMESPACE}/${SHORT_NAME}:${TAG}\` | \`docker pull $DST\` |" >> $GITHUB_STEP_SUMMARY
              SUCCESS=$((SUCCESS + 1))
            else
              echo "âŒ å¤±è´¥: $SRC"
              echo "| âŒ | \`$SRC\` | - | åŒæ­¥å¤±è´¥ |" >> $GITHUB_STEP_SUMMARY
              FAIL=$((FAIL + 1))
            fi
            echo ""

          done <<< "${{ inputs.image }}"

          # â”€â”€ æ±‡æ€» â”€â”€
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**ðŸ“Š æ±‡æ€»**: å…± ${TOTAL} ä¸ªé•œåƒ Â· âœ… æˆåŠŸ ${SUCCESS} Â· âŒ å¤±è´¥ ${FAIL}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "> ðŸ  é˜¿é‡Œäº‘ä»“åº“å‰ç¼€: \`${REGISTRY}/${NAMESPACE}/\`" >> $GITHUB_STEP_SUMMARY

          # å¦‚æžœæœ‰å¤±è´¥åˆ™æ ‡è®°æ•´ä¸ª job ä¸ºå¤±è´¥
          if [[ $FAIL -gt 0 ]]; then
            exit 1
          fi
